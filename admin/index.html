<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Database Peserta</title>
    <!-- Load QRCode library with fallback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase fallback jika CDN tidak tersedia -->
    <script>
        // Firebase fallback loader
        window.firebaseLoaded = false;
        
        function loadFirebaseWithFallback() {
            const firebaseScript = document.createElement('script');
            firebaseScript.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
            firebaseScript.onload = function() {
                console.log('Firebase App loaded');
                // Load Firestore
                const firestoreScript = document.createElement('script');
                firestoreScript.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
                firestoreScript.onload = function() {
                    console.log('Firebase Firestore loaded');
                    window.firebaseLoaded = true;
                };
                firestoreScript.onerror = function() {
                    console.error('Failed to load Firebase Firestore');
                    showFirebaseError();
                };
                document.head.appendChild(firestoreScript);
            };
            firebaseScript.onerror = function() {
                console.error('Failed to load Firebase App');
                showFirebaseError();
            };
            document.head.appendChild(firebaseScript);
        }
        
        function showFirebaseError() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 48px; color: #dc3545; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <h3>Gagal Memuat Firebase</h3>
                        <p>Tidak dapat terhubung ke database. Kemungkinan penyebab:</p>
                        <ul style="text-align: left; display: inline-block; margin: 20px 0;">
                            <li>Koneksi internet terputus</li>
                            <li>Firebase CDN terblokir</li>
                            <li>Ad blocker aktif</li>
                        </ul>
                        <div style="margin-top: 20px;">
                            <button onclick="location.reload()" style="padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                üîÑ Refresh
                            </button>
                            <button onclick="showDemoData()" style="padding: 10px 20px; margin: 5px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                üëÅÔ∏è Tampilkan Data Demo
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        function showDemoData() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const tableBody = document.getElementById('tableBody');
            
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 2em; margin-bottom: 10px;">üîß</div>
                            <h3>Mode Demo</h3>
                            <p>Firebase tidak tersedia. Berikut data contoh:</p>
                            <div style="max-width: 500px; margin: 20px auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                <p><strong>Kode:</strong> DEMO001</p>
                                <p><strong>Nama:</strong> John Doe</p>
                                <p><strong>Email:</strong> demo@example.com</p>
                                <p><strong>Status:</strong> ‚ùå Koneksi database terputus</p>
                            </div>
                            <p style="margin-top: 20px; color: #999;">
                                <i>Hubungkan ke internet untuk melihat data asli</i>
                            </p>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Load Firebase saat halaman dimuat
        document.addEventListener('DOMContentLoaded', loadFirebaseWithFallback);
    </script>
</head>
<body>
    <nav>
        <a href="index.html" class="active">üìä Data Peserta</a>
        <a href="scan.html">üì± Scan QR</a>
    </nav>

    <div class="container">
        <h2>Database Peserta (Realtime)</h2>
        <div class="controls">
            <input type="text" id="searchInput" placeholder="üîç Cari nama/kode..." onkeyup="searchData()">
            <button id="btnSort" onclick="sortData()">üìä Urutkan A-Z</button>
        </div>
        
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>QR Code</th>
                        <th>Kode</th>
                        <th>Nama</th>
                        <th>Nomor Tiket</th>
                        <th>Email</th>
                        <th>No HP</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Data akan diisi oleh JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; align-items: center; justify-content: center; flex-direction: column;">
        <div style="width: 60px; height: 60px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 20px; font-weight: 500; color: #333;">Memuat data peserta...</p>
        <p id="loadingStatus" style="margin-top: 10px; color: #666; font-size: 0.9em;">Menyiapkan aplikasi...</p>
        <button onclick="location.reload()" style="margin-top: 20px; padding: 8px 16px; background: transparent; color: #666; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; display: none;" id="reloadButton">
            ‚è≥ Loading...
        </button>
    </div>

    <!-- Notification Toast -->
    <div id="toast" style="position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 16px 24px; border-radius: 8px; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <span id="toastMessage"></span>
    </div>

    <script type="module" src="script-admin.js"></script>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .qr-container {
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
    
    <script>
        // Debug info
        console.log('Page loaded at:', new Date().toLocaleTimeString());
        
        // Update loading status
        setTimeout(() => {
            const loadingStatus = document.getElementById('loadingStatus');
            const reloadButton = document.getElementById('reloadButton');
            
            if (loadingStatus) {
                loadingStatus.textContent = 'Menghubungkan ke database...';
            }
            
            // Show reload button after 5 seconds
            setTimeout(() => {
                if (reloadButton && document.getElementById('loadingOverlay').style.display !== 'none') {
                    reloadButton.style.display = 'block';
                    reloadButton.innerHTML = 'üîÑ Refresh Halaman';
                    reloadButton.onclick = function() {
                        this.innerHTML = '‚è≥ Refreshing...';
                        this.disabled = true;
                        location.reload();
                    };
                }
            }, 5000);
        }, 2000);
        
        // Check if QRCode library is loaded
        setTimeout(() => {
            if (typeof QRCode === 'undefined') {
                console.warn('QRCode library not loaded, retrying...');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js';
                document.head.appendChild(script);
            }
        }, 1000);
    </script>
</body>
</html>